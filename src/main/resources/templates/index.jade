html
  head
    meta(http-equiv="Content-Type" content="text/html;charset=UTF-8")
    title onedit
    link(type="text/css" rel="stylesheet" href="public/bootstrap/css/bootstrap.min.css")
    link(type="text/css" rel="stylesheet" href="public/bootstrap/css/bootstrap-responsive.min.css")
    link(type="text/css" rel="stylesheet" href="public/shjs-0.6/sh_style.min.css")
    script(type="text/javascript" src="public/jquery-1.7.1.min.js")
    script(type="text/javascript" src="public/bootstrap/js/bootstrap.js")
    script(type="text/javascript" src="public/shjs-0.6/sh_main.min.js")
    :css
      body {
        padding-top: 60px;
      }
    :coffeescript
      filename = (name) ->
        $('#save-form').attr 'action', '/save/' + name
      highlight = -> sh_highlightDocument('public/shjs-0.6/lang/', '.min.js')
      syntax = (sh) ->
        window.localStorage.sh = sh
        if sh != ''
          $('#buffer').attr 'class', 'sh_' + sh
        else
          $('#buffer').removeAttr 'class'
        filename window.localStorage.file + if sh then '.' + sh else ''
      buffer = ->
        $('#buffer br').replaceWith('\n')
        $('#buffer').text()
      view = (data) -> $('#view').html data
      $('.dropdown-toggle').dropdown()
      if !window.localStorage.file
        window.localStorage.file = 'out'
      $(document).ready ->
        $('#open').click -> $('#file').click()
        $('#file').change ->
          name = $('#file').val()
          syntax name.substr(name.lastIndexOf('.') + 1)
          $('#load-file').click()
        $('#upload-target').load ->
          $('#buffer').text $('#upload-target').contents().text()
          highlight()
        $('#save').click ->
          $('#hidden-buffer').val buffer()
          $('#submit-buffer').click()
        $('#save-local').click -> window.localStorage.buffer = buffer()
        $('.lang').click (event) ->
          sh = $(event.target).attr 'sh'
          syntax sh
          highlight()
        $('#view-markup').click -> view buffer()
        $('#compile-markdown').click ->
          $.post 'markdown', { content: buffer() }, view, 'text'
        $('#save-view-source').click ->
          source = $('#view').html()
          if source != ''
            $('#hidden-buffer').val source
            $('#submit-buffer').click()
        $('#buffer').blur -> highlight()
        filename window.localStorage.file
        if window.localStorage.buffer
          $('#buffer').append window.localStorage.buffer
  body
    .navbar.navbar-fixed-top
      .navbar-inner
        .container
          a.brand(href="#") onedit
          .nav-collapse
            ul.nav
              li.dropdown
                a.dropdown-toggle(href="#" data-toggle="dropdown")
                  | File
                  b.caret
                ul.dropdown-menu
                  li
                    a#open(href="#") Open
                    iframe#upload-target.hide(name="upload-target")
                  li
                    a#save(href="#") Save
                  li
                    a#save-local(href="#") Save Local
                  li
                    a#quit(href="#") Quit
              li.dropdown
                a.dropdown-toggle(href="#" data-toggle="dropdown")
                  | Language
                  b.caret
                ul.dropdown-menu
                  li
                    a.lang(href="#" sh="") Plain
                    a.lang(href="#" sh="c") C
                    a.lang(href="#" sh="cpp") C++
                    a.lang(href="#" sh="csharp") C#
                    a.lang(href="#" sh="css") CSS
                    a.lang(href="#" sh="html") HTML
                    a.lang(href="#" sh="java") Java
                    a.lang(href="#" sh="javascript") JavaScript
                    a.lang(href="#" sh="perl") Perl
                    a.lang(href="#" sh="php") PHP
                    a.lang(href="#" sh="prolog") Prolog
                    a.lang(href="#" sh="python") Python
                    a.lang(href="#" sh="ruby") Ruby
                    a.lang(href="#" sh="scala") Scala
                    a.lang(href="#" sh="sh") sh
                    a.lang(href="#" sh="xml") XML
              li.dropdown
                a.dropdown-toggle(href="#" data-toggle="dropdown")
                  | Compile
                  b.caret
                ul.dropdown-menu
                  li
                    a#view-markup(href="#") View Markup
                    a#compile-markdown(href="#") Compile Markdown
                    a#save-view-source(href="#") Save View Source
    .container-fluid
      .row-fluid
        .span6
          pre#buffer(contenteditable="true")
        .span6
          #view
    .hide
      form(method="post" action="/open" enctype="multipart/form-data" target="upload-target")
        input#file(name="file" type="file" required=true)
        input#load-file(type="submit")
      form#save-form(method="post" action="/save" target="_blank")
        textarea#hidden-buffer(name="content")
        input#submit-buffer(type="submit")
